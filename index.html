<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>برنامج توزيع الكتب المدرسية</title>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Almarai:wght@400;700&family=Tajawal:wght@400;700&display=swap" rel="stylesheet">
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

    <style>
        :root {
            --primary-color: #0056b3; --secondary-color: #f8f9fa; --border-color: #dee2e6;
            --text-color: #333; --header-color: #004085; --success-color: #28a745;
            --danger-color: #dc3545; --font-family: 'Tajawal', 'Almarai', sans-serif;
            --school-bg: #fff; --class-bg: #fdfdfd; --subject-bg: #f9f9f9;
        }
        body { font-family: var(--font-family); background-color: var(--secondary-color); color: var(--text-color); margin: 0; padding: 20px; }
        .container { max-width: 1200px; margin: 0 auto; background-color: #fff; padding: 25px; border-radius: 8px; box-shadow: 0 4px 8px rgba(0,0,0,0.1); }
        header { text-align: center; margin-bottom: 30px; border-bottom: 2px solid var(--border-color); padding-bottom: 20px; }
        header h1 { font-size: 2.5em; color: var(--header-color); margin: 0; }
        header p { font-size: 1em; color: #6c757d; margin-top: 5px; }

        .tabs { display: flex; justify-content: center; margin-bottom: 25px; border-bottom: 1px solid var(--border-color); }
        .tab-button { padding: 12px 25px; cursor: pointer; border: none; background-color: transparent; font-size: 1.2em; font-family: var(--font-family); margin: 0 5px; border-bottom: 3px solid transparent; }
        .tab-button.active { color: var(--primary-color); border-bottom-color: var(--primary-color); }
        .tab-content { display: none; }
        .tab-content.active { display: block; }

        .school-container { background-color: var(--school-bg); border: 2px solid #b8daff; border-radius: 8px; padding: 15px; margin-bottom: 20px; }
        .school-header, .class-header { display: flex; gap: 15px; align-items: center; margin-bottom: 15px; }
        .school-header input, .class-header input { flex-grow: 1; padding: 10px; border: 1px solid var(--border-color); border-radius: 5px; font-size: 1.2em; font-weight: bold; }
        .class-container { background-color: var(--class-bg); border: 1px solid #cfe2ff; border-radius: 6px; padding: 15px; margin-top: 15px; margin-right: 20px; }
        .subject-entry { display: flex; flex-wrap: wrap; gap: 15px; padding: 15px; border: 1px dashed #ced4da; border-radius: 8px; margin-top: 10px; margin-right: 20px; align-items: flex-end; position: relative; background: var(--subject-bg); }
        
        .input-group { display: flex; flex-direction: column; flex: 1; min-width: 120px; }
        .input-group label { margin-bottom: 5px; font-weight: bold; font-size: 0.9em; }
        .input-group input { padding: 10px; border: 1px solid var(--border-color); border-radius: 5px; font-size: 1em; width: 100%; box-sizing: border-box; }
        
        .result-area { flex-basis: 100%; margin-top: 15px; padding: 15px; background-color: #eef7ff; border: 1px dashed var(--primary-color); border-radius: 5px; font-weight: bold; min-height: 60px; text-align: center; }
        .result-area .calculation-base { font-size: 0.9em; font-weight: normal; color: #495057; margin-bottom: 10px; border-bottom: 1px solid #ced4da; padding-bottom: 10px; }
        .result-area .carton-details { font-size: 0.85em; font-weight: normal; margin-top: 10px; }

        .btn-add-level, .remove-btn { padding: 8px 15px; font-size: 0.9em; border-radius: 5px; border: none; cursor: pointer; color: white; }
        .btn-add-level { background-color: var(--primary-color); }
        .remove-btn { background: var(--danger-color); font-weight: bold; }
        
        .action-buttons { display: flex; justify-content: center; gap: 15px; margin-top: 25px; }
        .action-buttons button { padding: 12px 30px; font-size: 1.1em; border-radius: 5px; border: none; cursor: pointer; }
        .btn-add-school { background-color: var(--header-color); color: white; width: 100%; padding: 15px; }
        .btn-calculate { background-color: var(--success-color); color: white; }
        .btn-export { background-color: #1d6f42; color: white; }
        
        /* --- Log/History Styles --- */
        .log-entry { border: 1px solid var(--border-color); border-radius: 6px; margin-bottom: 15px; overflow: hidden; }
        .log-header { padding: 15px; background-color: #f8f9fa; cursor: pointer; display: flex; justify-content: space-between; align-items: center; }
        .log-header:hover { background-color: #e9ecef; }
        .log-details { padding: 15px; max-height: 0; overflow: hidden; transition: max-height 0.3s ease-out; background-color: #fff; }
        .log-entry.active .log-details { max-height: 1000px; /* Large enough value */ }
        .log-table { width: 100%; border-collapse: collapse; }
        .log-table th, .log-table td { border: 1px solid var(--border-color); padding: 8px; text-align: right; }
        .log-table th { background-color: #e9ecef; }

        @media (max-width: 768px) { .class-container, .subject-entry { margin-right: 0; } }
    </style>
</head>
<body>

    <div class="container">
        <header>
            <h1>برنامج توزيع الكتب المدرسية</h1>
            <p>تم الإنشاء والتطوير بواسطة حارث الغنبوصي </p>
        </header>

        <div class="tabs">
            <button class="tab-button active" onclick="showTab('inputs-tab', this)">المدخلات</button>
            <button class="tab-button" onclick="showTab('log-tab', this)">السجل</button>
        </div>

        <div id="inputs-tab" class="tab-content active">
            <div id="schools-container"></div>
            <div class="action-buttons">
                <button class="btn-add-school" onclick="addSchool()">+ إضافة مدرسة جديدة</button>
            </div>
        </div>

        <div id="log-tab" class="tab-content">
            <div id="log-container">
                <p>لا توجد عمليات مسجلة بعد. اضغط على "احسب الجميع" لتسجيل عملية.</p>
            </div>
        </div>

        <div class="action-buttons" style="margin-top: 20px; border-top: 1px solid var(--border-color); padding-top: 20px;">
            <button class="btn-calculate" onclick="calculateAll()">احسب الجميع</button>
            <button class="btn-export" onclick="exportToExcel()">تصدير إلى Excel</button>
        </div>
    </div>

<script>
let calculationLog = []; // Array to store history

document.addEventListener('DOMContentLoaded', () => {
    addSchool();
    document.querySelector('#log-container').addEventListener('click', function(e) {
        if (e.target.closest('.log-header')) {
            e.target.closest('.log-entry').classList.toggle('active');
        }
    });
});

function showTab(tabId, element) {
    document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
    document.querySelectorAll('.tab-button').forEach(b => b.classList.remove('active'));
    document.getElementById(tabId).classList.add('active');
    element.classList.add('active');
}

// --- Functions to add elements ---
function addSchool() { /* ... Same as before ... */ 
    const container = document.getElementById('schools-container');
    const schoolId = 'school-' + Date.now();
    const schoolDiv = document.createElement('div');
    schoolDiv.className = 'school-container';
    schoolDiv.id = schoolId;
    schoolDiv.innerHTML = `<div class="school-header"><input type="text" class="school-name" placeholder="أدخل اسم المدرسة"><button class="btn-add-level" onclick="addClass('${schoolId}')">إضافة صف</button><button class="remove-btn" onclick="this.closest('.school-container').remove()">حذف المدرسة</button></div><div class="class-list"></div>`;
    container.appendChild(schoolDiv);
    addClass(schoolId);
}
function addClass(schoolId) { /* ... Same as before ... */ 
    const schoolContainer = document.getElementById(schoolId);
    const classList = schoolContainer.querySelector('.class-list');
    const classId = 'class-' + Date.now();
    const classDiv = document.createElement('div');
    classDiv.className = 'class-container';
    classDiv.id = classId;
    classDiv.innerHTML = `<div class="class-header"><input type="text" class="class-name" placeholder="أدخل اسم الصف (مثال: الخامس)"><button class="btn-add-level" onclick="addSubject('${classId}')">إضافة مادة</button><button class="remove-btn" onclick="this.closest('.class-container').remove()">حذف الصف</button></div><div class="subject-list"></div>`;
    classList.appendChild(classDiv);
    addSubject(classId);
}
function addSubject(classId) { /* ... Same as before ... */
    const classContainer = document.getElementById(classId);
    const subjectList = classContainer.querySelector('.subject-list');
    const subjectDiv = document.createElement('div');
    subjectDiv.className = 'subject-entry';
    subjectDiv.innerHTML = `<button class="remove-btn" style="position: absolute; top: 10px; left: 10px; padding: 5px 10px;" onclick="this.closest('.subject-entry').remove()">×</button><div class="input-group"><label>اسم المادة</label><input type="text" class="subject-name" placeholder="لغة عربية..."></div><div class="input-group"><label>عدد الطلاب</label><input type="number" class="student-count" placeholder="0" min="0"></div><div class="input-group"><label>نسبة التوزيع (%)</label><input type="number" class="distribution-percentage" value="100" min="0" max="100"></div><div class="input-group"><label>الكتب بالكرتون</label><input type="number" class="carton-size" placeholder="0" min="1"></div><div class="result-area">النتيجة ستظهر هنا...</div>`;
    subjectList.appendChild(subjectDiv);
}

// --- Calculation and Logging ---
function calculateAll() {
    const logDetails = [];
    document.querySelectorAll('.school-container').forEach(school => {
        const schoolName = school.querySelector('.school-name').value || 'مدرسة غير مسماة';
        school.querySelectorAll('.class-container').forEach(cls => {
            const className = cls.querySelector('.class-name').value || 'صف غير مسمى';
            cls.querySelectorAll('.subject-entry').forEach(subject => {
                const result = calculateSingleSubject(subject);
                if (result) {
                    logDetails.push({ schoolName, className, ...result });
                }
            });
        });
    });

    if(logDetails.length > 0) {
        const timestamp = new Date();
        const summary = `تم حساب ${logDetails.length} مادة في ${logDetails.reduce((acc, curr) => acc.add(curr.className), new Set()).size} صفوف.`;
        calculationLog.unshift({ timestamp, summary, details: logDetails }); // Add to beginning of log
        renderLog();
        alert("تم الحساب وحفظ النتائج في السجل.");
    } else {
        alert("لم يتم العثور على بيانات صالحة للحساب.");
    }
}

function calculateSingleSubject(subject) {
    const originalStudents = parseInt(subject.querySelector('.student-count').value) || 0;
    const percentage = parseFloat(subject.querySelector('.distribution-percentage').value) || 100;
    const cartonSize = parseInt(subject.querySelector('.carton-size').value) || 0;
    const resultArea = subject.querySelector('.result-area');

    if (originalStudents <= 0 || cartonSize <= 0) {
        resultArea.innerHTML = `<span style="color: var(--danger-color);">الرجاء إدخال قيم صحيحة.</span>`;
        return null;
    }

    const effectiveStudents = Math.round(originalStudents * (percentage / 100));
    const fullCartons = Math.floor(effectiveStudents / cartonSize);
    const remainder = effectiveStudents % cartonSize;
    
    let resultText, requiredCartons, extraBooksInfo;
    if (remainder === 0) {
        requiredCartons = fullCartons; extraBooksInfo = "0";
        resultText = `الكمية: <strong>${requiredCartons}</strong> كرتون بالضبط.`;
    } else if (remainder > cartonSize / 2) {
        requiredCartons = fullCartons + 1; extraBooksInfo = `إزالة ${cartonSize - remainder}`;
        resultText = `الكمية: <strong>${requiredCartons}</strong> كرتون، مع <strong>إزالة ${cartonSize - remainder}</strong> كتاب.`;
    } else {
        requiredCartons = fullCartons; extraBooksInfo = `إضافة ${remainder}`;
        resultText = `الكمية: <strong>${requiredCartons}</strong> كرتون، مع <strong>إضافة ${remainder}</strong> كتاب.`;
    }
    
    const quarter = Math.round(cartonSize * 0.25);
    const half = Math.round(cartonSize * 0.5);
    const threeQuarters = Math.round(cartonSize * 0.75);

    resultArea.innerHTML = `
        <div class="calculation-base">الحساب لـ <strong>${effectiveStudents}</strong> طالب (بنسبة ${percentage}%)</div>
        <div>${resultText}</div>
        <div class="carton-details">تفصيل الكرتون: ربع=${quarter} | نصف=${half} | ثلاثة أرباع=${threeQuarters}</div>
    `;

    return {
        subjectName: subject.querySelector('.subject-name').value || 'N/A',
        originalStudents, percentage: `${percentage}%`, effectiveStudents, cartonSize,
        requiredCartons, extraBooksInfo
    };
}

function renderLog() {
    const logContainer = document.getElementById('log-container');
    if (calculationLog.length === 0) {
        logContainer.innerHTML = '<p>لا توجد عمليات مسجلة بعد.</p>';
        return;
    }

    logContainer.innerHTML = ''; // Clear previous log
    calculationLog.forEach((log, index) => {
        const logEntryDiv = document.createElement('div');
        logEntryDiv.className = 'log-entry';
        
        let tableRows = '';
        log.details.forEach(d => {
            tableRows += `<tr><td>${d.schoolName}</td><td>${d.className}</td><td>${d.subjectName}</td><td>${d.requiredCartons}</td><td>${d.extraBooksInfo}</td></tr>`;
        });

        logEntryDiv.innerHTML = `
            <div class="log-header">
                <strong>عملية #${calculationLog.length - index}</strong>
                <span>${log.summary}</span>
                <span>${log.timestamp.toLocaleTimeString('ar-EG')} - ${log.timestamp.toLocaleDateString('ar-EG')}</span>
            </div>
            <div class="log-details">
                <table class="log-table">
                    <thead><tr><th>المدرسة</th><th>الصف</th><th>المادة</th><th>الكراتين</th><th>الزيادة/النقص</th></tr></thead>
                    <tbody>${tableRows}</tbody>
                </table>
            </div>
        `;
        logContainer.appendChild(logEntryDiv);
    });
}

// --- Export Logic ---
function exportToExcel() {
    // This function is now independent and pulls fresh data from the form
    const data = [];
    const headers = ["اسم المدرسة", "اسم الصف", "اسم المادة", "عدد الطلاب", "نسبة التوزيع", "عدد التوزيع", "الكتب بالكرتون", "الكراتين المطلوبة", "الكتب الزائدة/الناقصة"];
    data.push(headers);
    let hasValidData = false;
    document.querySelectorAll('.school-container').forEach(school => {
        const schoolName = school.querySelector('.school-name').value || 'مدرسة غير مسماة';
        school.querySelectorAll('.class-container').forEach(cls => {
            const className = cls.querySelector('.class-name').value || 'صف غير مسمى';
            cls.querySelectorAll('.subject-entry').forEach(subject => {
                const result = calculateSingleSubject(subject); // Recalculate to ensure data is fresh
                if (result) {
                    hasValidData = true;
                    data.push([schoolName, className, result.subjectName, result.originalStudents, result.percentage, result.effectiveStudents, result.cartonSize, result.requiredCartons, result.extraBooksInfo]);
                }
            });
        });
    });

    if (!hasValidData) {
        alert("لا توجد بيانات صالحة للتصدير. الرجاء ملء الحقول أولاً.");
        return;
    }

    const worksheet = XLSX.utils.aoa_to_sheet(data);
    const workbook = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(workbook, worksheet, "تقرير التوزيع");
    worksheet['!cols'] = [{wch:25},{wch:15},{wch:20},{wch:12},{wch:15},{wch:15},{wch:15},{wch:15},{wch:20}];
    XLSX.writeFile(workbook, "تقرير_التوزيع_المدارس.xlsx");
}
</script>

</body>
</html>
